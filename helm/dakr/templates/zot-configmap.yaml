{{- if and .Values.runtimeConfig.enabled .Values.runtimeConfig.registryMirrors.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dakr.fullname" . }}-zot-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dakr.labels" . | nindent 4 }}
    app.kubernetes.io/component: zot-registry
data:
  config.json: |
    {
      "distSpecVersion": "1.1.0",
      "storage": {
        "rootDirectory": "/var/lib/registry",
        "dedupe": true,
        "gc": true,
        "gcDelay": "1h",
        "gcInterval": "24h"
      },
      "http": {
        "address": "0.0.0.0",
        "port": "{{ $.Values.runtimeConfig.registryMirrors.service.registryPort }}"
      },
      "log": {
        "level": "{{ $.Values.runtimeConfig.registryMirrors.zot.logLevel | default "info" }}"
      },
      "extensions": {
        "sync": {
          "enable": true,
          {{- /* Add credentialsFile if any registry has credentials */ -}}
          {{- $hasCredentials := false -}}
          {{- range .Values.runtimeConfig.registryMirrors.registries -}}
            {{- if and .enabled .credentials (or .credentials.username .credentials.password) -}}
              {{- $hasCredentials = true -}}
            {{- end -}}
          {{- end -}}
          {{- if $hasCredentials }}
          {{- if .Values.runtimeConfig.registryMirrors.credentialsSecret.existingSecret }}
          "credentialsFile": "/etc/zot/credentials/{{ .Values.runtimeConfig.registryMirrors.credentialsSecret.key }}",
          {{- else }}
          "credentialsFile": "/etc/zot/credentials/credentials.json",
          {{- end }}
          {{- end }}
          "registries": [
            {{- $registries := list }}
            {{- range .Values.runtimeConfig.registryMirrors.registries }}
            {{- if .enabled }}
            {{- $registries = append $registries . }}
            {{- end }}
            {{- end }}
            {{- range $index, $registry := $registries }}
            {
              "urls": ["{{ $registry.upstream }}"],
              {{- if $registry.credentialHelper }}
              "credentialHelper": "{{ $registry.credentialHelper }}",
              {{- end }}
              "content": [
                {
                  "prefix": "**",
                  "destination": "/{{ $registry.name }}",
                  "stripPrefix": false
                }
              ],
              "onDemand": true,
              "tlsVerify": true
            }{{- if ne (add1 $index) (len $registries) }},{{- end }}
            {{- end }}
          ]
        },
        "metrics": {
          "enable": true,
          "prometheus": {
            "path": "/metrics"
          }
        }
      }
    }
{{- end }}
